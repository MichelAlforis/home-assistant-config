<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>üè† Home Assistant Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Maison">
    <link rel="apple-touch-icon" href="/local/icon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, "Helvetica Neue", Helvetica, Arial, sans-serif;
            background: center / cover no-repeat url("/local/fond_tablette.webp") fixed;
            min-height: 100vh;
            color: #FFF; /* Changed text color to white for better contrast on image */
            padding: 10px;
            -webkit-text-size-adjust: none;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            padding: 10px;
        }

        .header h1 {
            font-size: 2em;
            font-weight: 300;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header-info {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .section {
            background: rgba(0, 0, 0, 0.3);
            -webkit-border-radius: 12px;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section h3 {
            color: #ffffff;
            margin-bottom: 12px;
            font-size: 1.2em;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 8px;
        }

        .entity {
            background: rgba(255, 255, 255, 0.1);
            -webkit-border-radius: 8px;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-align-items: center;
            align-items: center;
            -webkit-transition: all 0.2s ease;
            transition: all 0.2s ease;
        }

        .entity:active {
            background: #e9ecef;
        }

        .entity-info {
            -webkit-flex: 1;
            flex: 1;
            min-width: 0;
        }

        .entity-name {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 3px;
            font-size: 0.95em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .entity-state {
            color: #dddddd;
            font-size: 0.85em;
        }

        .control-btn {
            background: -webkit-linear-gradient(45deg, #1565C0, #1976D2);
            background: linear-gradient(45deg, #1565C0, #1976D2);
            color: white;
            border: none;
            padding: 8px 0;
            width: 80px;
            -webkit-border-radius: 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85em;
            -webkit-transition: all 0.2s ease;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            outline: none;
            text-align: center;
        }

        .control-btn:active {
            -webkit-transform: scale(0.95);
            transform: scale(0.95);
        }

        .control-btn.off {
            background: -webkit-linear-gradient(45deg, #c62828, #d32f2f);
            background: linear-gradient(45deg, #c62828, #d32f2f);
        }

        .config-panel {
            background: rgba(0, 0, 0, 0.3);
            -webkit-border-radius: 12px;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .config-panel h3 {
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .config-panel input {
            width: 100%;
            padding: 12px;
            margin: 6px 0;
            border: 2px solid #e9ecef;
            -webkit-border-radius: 6px;
            border-radius: 6px;
            font-size: 1em;
            -webkit-appearance: none;
            background: white;
        }

        .config-panel input:focus {
            outline: none;
            border-color: #667eea;
        }

        .config-panel button {
            background: -webkit-linear-gradient(45deg, #667eea, #764ba2);
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            -webkit-border-radius: 20px;
            border-radius: 20px;
            font-weight: 600;
            margin-top: 10px;
            width: 100%;
            font-size: 1em;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 30px;
            font-size: 1.1em;
        }

        .error {
            background: rgba(244, 67, 54, 0.1);
            color: #d32f2f;
            padding: 12px;
            -webkit-border-radius: 8px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #f44336;
            font-size: 0.9em;
        }

        .last-update {
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-size: 0.8em;
            margin-top: 15px;
            padding: 10px;
        }

        .climate-info {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            margin-top: 5px;
        }

        .climate-temp {
            font-size: 0.9em;
            color: #2980b9;
            font-weight: 600;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            -webkit-border-radius: 50%;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-on { background: #4CAF50; }
        .status-off { background: #f44336; }
        .status-unavailable { background: #9e9e9e; }

        /* Navigation Buttons */
        .nav-grid {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 15px;
        }
        .nav-section {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            min-width: 200px;
        }
        .button-grid {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-flex-direction: column;
            flex-direction: column;
            gap: 10px;
        }
        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            padding: 20px;
            text-align: center;
            -webkit-border-radius: 12px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            -webkit-transition: all 0.2s ease;
            transition: all 0.2s ease;
        }
        .nav-btn:active {
            background: rgba(255, 255, 255, 0.2);
            -webkit-transform: scale(0.98);
            transform: scale(0.98);
        }

        /* Optimisations pour iPad */
        @media (min-width: 768px) {
            body { padding: 20px; }
            .header h1 { font-size: 2.5em; }
            .section { padding: 20px; }
            .entity { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="greeting">Bonjour !</h1>
        <div class="header-info" id="date">-- -- ----</div>
    </div>

    <div class="config-panel" id="configPanel">
        <h3>‚öôÔ∏è Configuration de connexion</h3>
        <input type="text" id="haUrl" placeholder="URL Home Assistant (ex: http://192.168.1.100:8123)" autocomplete="off" />
        <input type="password" id="haToken" placeholder="Token d'acc√®s long terme" autocomplete="off" />
        <button onclick="saveConfig()">Se connecter</button>
        <div style="margin-top: 10px; font-size: 0.85em; color: #dddddd;">
            üí° Pour cr√©er un token : Profil ‚Üí Tokens d'acc√®s long terme
        </div>
    </div>

    <div class="loading" id="loading" style="display: none;">
        <div>üîÑ Connexion en cours...</div>
    </div>

    <div id="content" class="nav-grid"></div>
    <div class="last-update" id="lastUpdate"></div>

    <script>
        // Variables globales
        var haUrl = '';
        var haToken = '';
        var entities = [];
        var refreshInterval;
        var isLoading = false;

        // Initialisation au chargement de la page
        function initApp() {
            console.log('Application d√©marr√©e');
            loadStoredConfig();

            if (haUrl && haToken) {
                hideConfigPanel();
                startAutoRefresh();
            }
        }

        // Chargement de la configuration stock√©e (simulation)
        function loadStoredConfig() {
            // Pour iOS 9.3.5, on ne peut pas utiliser localStorage de mani√®re fiable
            // La configuration devra √™tre saisie √† chaque fois
        }

        // Sauvegarde de la configuration
        function saveConfig() {
            var urlInput = document.getElementById('haUrl');
            var tokenInput = document.getElementById('haToken');

            haUrl = urlInput.value.replace(/\s/g, '');
            haToken = tokenInput.value.replace(/\s/g, '');

            if (!haUrl || !haToken) {
                showError('Veuillez remplir tous les champs de configuration');
                return;
            }

            // Nettoyer l'URL
            if (haUrl.charAt(haUrl.length - 1) === '/') {
                haUrl = haUrl.slice(0, -1);
            }

            if (haUrl.indexOf('http') !== 0) {
                haUrl = 'http://' + haUrl;
            }

            console.log('Configuration sauvegard√©e:', haUrl);
            hideConfigPanel();
            startAutoRefresh();
        }

        function hideConfigPanel() {
            document.getElementById('configPanel').style.display = 'none';
        }

        function showConfigPanel() {
            document.getElementById('configPanel').style.display = 'block';
        }

        // D√©marrage du rafra√Æchissement automatique
        function startAutoRefresh() {
            loadStates();
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            refreshInterval = setInterval(function() {
                loadStates();
            }, 8000);
        }

        // Chargement des √©tats depuis Home Assistant
        function loadStates() {
            if (isLoading) return;
            isLoading = true;

            var loadingEl = document.getElementById('loading');
            loadingEl.style.display = 'block';

            var xhr = new XMLHttpRequest();
            xhr.open('GET', haUrl + '/api/states', true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + haToken);
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    isLoading = false;
                    loadingEl.style.display = 'none';

                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            entities = data; // We still store entities for potential future use
                            displayHomepage(); // Display the navigation menu
                            updateLastRefresh();
                            clearErrors();
                        } catch (e) {
                            console.error('Erreur parsing:', e);
                            showError('Erreur de traitement des donn√©es: ' + e.message);
                        }
                    } else if (xhr.status === 401) {
                        showError('üîê Token invalide - V√©rifiez votre token d\'acc√®s');
                        showConfigPanel();
                    } else if (xhr.status === 0) {
                        showError('üåê Impossible de se connecter - V√©rifiez votre URL et votre r√©seau');
                    } else {
                        showError('‚ö†Ô∏è Erreur de connexion (Code: ' + xhr.status + ')');
                    }
                }
            };

            xhr.onerror = function() {
                isLoading = false;
                loadingEl.style.display = 'none';
                showError('üîå Erreur r√©seau - V√©rifiez votre connexion Internet');
            };

            try {
                xhr.send();
            } catch (e) {
                isLoading = false;
                loadingEl.style.display = 'none';
                showError('Erreur lors de l'envoi de la requ√™te');
            }
        }

        // Affichage de la page d'accueil
        function displayHomepage() {
            var content = document.getElementById('content');
            var html = '';

            // Section Pi√®ces
            html += '<div class="section nav-section">';
            html += '<h3>üè† Pi√®ces</h3>';
            html += '<div class="button-grid">';
            html += '<a href="rooms.html?room=rdc" class="nav-btn">RDC</a>';
            html += '<a href="rooms.html?room=etage1" class="nav-btn">R+1</a>';
            html += '<a href="rooms.html?room=etage2" class="nav-btn">R+2</a>';
            html += '</div></div>';

            // Section Mat√©riel
            html += '<div class="section nav-section">';
            html += '<h3>üß∞ Mat√©riel</h3>';
            html += '<div class="button-grid">';
            html += '<a href="devices.html?device=volets" class="nav-btn">Volets</a>';
            html += '<a href="devices.html?device=temperature" class="nav-btn">Temp√©rature</a>';
            html += '<a href="devices.html?device=electromenager" class="nav-btn">√âlectrom√©nager</a>';
            html += '<a href="devices.html?device=exterieur" class="nav-btn">Ext√©rieur</a>';
            html += '</div></div>';

            // Section Sc√©narios
            html += '<div class="section nav-section">';
            html += '<h3>üé¨ Sc√©narios</h3>';
            html += '<div class="button-grid">';
            html += '<button class="nav-btn scenario-btn" data-service="script.scenario_reveil">üåÖ R√©veil</button>';
            html += '<button class="nav-btn scenario-btn" data-service="script.scenario_coucher">üåô Coucher</button>';
            html += '<button class="nav-btn scenario-btn" data-service="script.scenario_absent">üè† Absent</button>';
            html += '<button class="nav-btn scenario-btn" data-service="script.scenario_fete">üéâ F√™te</button>';
            html += '</div></div>';

            content.innerHTML = html;

            // Add event listeners for scenario buttons
            var scenarioButtons = document.getElementsByClassName('scenario-btn');
            for (var i = 0; i < scenarioButtons.length; i++) {
                scenarioButtons[i].addEventListener('click', function(e) {
                    var service = e.currentTarget.getAttribute('data-service');
                    var friendlyName = e.currentTarget.innerText;
                    if (confirm('Lancer le sc√©nario "' + friendlyName + '" ?')) {
                        var domain = service.split('.')[0];
                        var serviceName = service.split('.')[1];
                        callService(domain, serviceName, { entity_id: service });
                    }
                });
            }
        }

        // Appel de service Home Assistant
        function callService(domain, service, data) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', haUrl + '/api/services/' + domain + '/' + service, true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + haToken);
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        // Rafra√Æchir apr√®s un court d√©lai
                        setTimeout(function() {
                            loadStates();
                        }, 800);
                    } else {
                        showError('‚ùå Erreur lors du contr√¥le de l\'√©quipement');
                    }
                }
            };

            xhr.send(JSON.stringify(data));
        }


        // Affichage des erreurs
        function showError(message) {
            var content = document.getElementById('content');
            var errorHtml = '<div class="error">' + message + '</div>';
            content.innerHTML = errorHtml + content.innerHTML;
        }

        // Effacement des erreurs
        function clearErrors() {
            var errors = document.getElementsByClassName('error');
            for (var i = errors.length - 1; i >= 0; i--) {
                errors[i].parentNode.removeChild(errors[i]);
            }
        }

        // Mise √† jour de l'heure de rafra√Æchissement
        function updateLastRefresh() {
            var now = new Date();
            var hours = now.getHours();
            var minutes = now.getMinutes();
            var seconds = now.getSeconds();

            if (hours < 10) hours = '0' + hours;
            if (minutes < 10) minutes = '0' + minutes;
            if (seconds < 10) seconds = '0' + seconds;

            var timeString = hours + ':' + minutes + ':' + seconds;
            document.getElementById('lastUpdate').innerHTML = 'üîÑ Mise √† jour : ' + timeString;
        }

        // Gestion des √©v√©nements tactiles pour iOS
        document.addEventListener('touchstart', function() {}, { passive: true });

        // D√©marrage de l'application
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // Nettoyage √† la fermeture
        window.onbeforeunload = function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        };
    </script>
</body>
</html>
