<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>üè† Home Assistant Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/local/icon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, "Helvetica Neue", Helvetica, Arial, sans-serif;
            background: -webkit-linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
            -webkit-text-size-adjust: none;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            padding: 10px;
        }

        .header h1 {
            font-size: 2em;
            font-weight: 300;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header-info {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Mode paysage - 3 colonnes */
        @media (orientation: landscape) and (min-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            body {
                padding: 15px;
            }
        }

        /* iPad et tablettes */
        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 25px;
            }
            
            body {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2.5em;
            }
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            -webkit-border-radius: 12px;
            border-radius: 12px;
            padding: 15px;
            -webkit-box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            break-inside: avoid;
        }

        .section h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.1em;
            font-weight: 600;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-count {
            background: #667eea;
            color: white;
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .entity {
            background: #f8f9fa;
            -webkit-border-radius: 8px;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-align-items: center;
            align-items: center;
            -webkit-transition: all 0.3s ease;
            transition: all 0.3s ease;
            position: relative;
        }

        .entity:active {
            background: #e9ecef;
            transform: scale(0.98);
        }

        .entity.updating {
            opacity: 0.7;
            pointer-events: none;
        }

        .entity.updating::after {
            content: "üîÑ";
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: translateY(-50%) rotate(0deg); }
            to { transform: translateY(-50%) rotate(360deg); }
        }

        .entity-info {
            -webkit-flex: 1;
            flex: 1;
            min-width: 0;
        }

        .entity-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 3px;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .entity-state {
            color: #666;
            font-size: 0.8em;
        }

        .control-btn {
            background: -webkit-linear-gradient(45deg, #4CAF50, #45a049);
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 8px 16px;
            -webkit-border-radius: 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8em;
            -webkit-transition: all 0.3s ease;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            outline: none;
            min-width: 50px;
            cursor: pointer;
        }

        .control-btn:active {
            -webkit-transform: scale(0.95);
            transform: scale(0.95);
        }

        .control-btn:hover {
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .control-btn.off {
            background: -webkit-linear-gradient(45deg, #f44336, #d32f2f);
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .control-btn.off:hover {
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .cover-controls {
            display: flex;
            gap: 5px;
        }

        .cover-controls .control-btn {
            padding: 6px 10px;
            font-size: 0.7em;
            min-width: 35px;
        }

        .config-panel {
            background: rgba(255, 255, 255, 0.95);
            -webkit-border-radius: 12px;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .config-panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .config-panel input {
            width: 100%;
            padding: 12px;
            margin: 6px 0;
            border: 2px solid #e9ecef;
            -webkit-border-radius: 6px;
            border-radius: 6px;
            font-size: 1em;
            -webkit-appearance: none;
            background: white;
        }

        .config-panel input:focus {
            outline: none;
            border-color: #667eea;
        }

        .config-panel button {
            background: -webkit-linear-gradient(45deg, #667eea, #764ba2);
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            -webkit-border-radius: 20px;
            border-radius: 20px;
            font-weight: 600;
            margin-top: 10px;
            width: 100%;
            font-size: 1em;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 30px;
            font-size: 1.1em;
        }

        .error {
            background: rgba(244, 67, 54, 0.1);
            color: #d32f2f;
            padding: 12px;
            -webkit-border-radius: 8px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #f44336;
            font-size: 0.9em;
        }

        .last-update {
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-size: 0.8em;
            margin-top: 15px;
            padding: 10px;
            grid-column: 1 / -1;
        }

        .climate-info {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            margin-top: 5px;
        }

        .climate-temp {
            font-size: 0.8em;
            color: #2980b9;
            font-weight: 600;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            -webkit-border-radius: 50%;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-on { background: #4CAF50; }
        .status-off { background: #f44336; }
        .status-unavailable { background: #9e9e9e; }

        .success-feedback {
            background: rgba(76, 175, 80, 0.1);
            color: #2e7d32;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            margin-top: 5px;
            border-left: 3px solid #4CAF50;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè† Home Assistant</h1>
        <div class="header-info">Tableau de bord connect√©</div>
    </div>

    <div class="config-panel" id="configPanel">
        <h3>‚öôÔ∏è Configuration de connexion</h3>
        <input type="text" id="haUrl" placeholder="URL Home Assistant (ex: http://192.168.1.100:8123)" autocomplete="off" />
        <input type="password" id="haToken" placeholder="Token d'acc√®s long terme" autocomplete="off" />
        <button onclick="saveConfig()">Se connecter</button>
        <div style="margin-top: 10px; font-size: 0.85em; color: #666;">
            üí° Pour cr√©er un token : Profil ‚Üí Tokens d'acc√®s long terme
        </div>
    </div>

    <div class="loading" id="loading" style="display: none;">
        <div>üîÑ Connexion en cours...</div>
    </div>
    
    <div class="dashboard-grid" id="content"></div>
    <div class="last-update" id="lastUpdate"></div>

    <script>
        // Variables globales
        var haUrl = '';
        var haToken = '';
        var entities = [];
        var refreshInterval;
        var isLoading = false;
        var pendingCommands = new Set();

        // Initialisation au chargement de la page
        function initApp() {
            console.log('Application d√©marr√©e');
            loadStoredConfig();
            
            if (haUrl && haToken) {
                hideConfigPanel();
                startAutoRefresh();
            }
        }

        // Chargement de la configuration stock√©e (simulation)
        function loadStoredConfig() {
            // Pour iOS 9.3.5, on ne peut pas utiliser localStorage de mani√®re fiable
            // La configuration devra √™tre saisie √† chaque fois
        }

        // Sauvegarde de la configuration
        function saveConfig() {
            var urlInput = document.getElementById('haUrl');
            var tokenInput = document.getElementById('haToken');
            
            haUrl = urlInput.value.replace(/\s/g, '');
            haToken = tokenInput.value.replace(/\s/g, '');
            
            if (!haUrl || !haToken) {
                showError('Veuillez remplir tous les champs de configuration');
                return;
            }
            
            // Nettoyer l'URL
            if (haUrl.charAt(haUrl.length - 1) === '/') {
                haUrl = haUrl.slice(0, -1);
            }
            
            if (haUrl.indexOf('http') !== 0) {
                haUrl = 'http://' + haUrl;
            }
            
            console.log('Configuration sauvegard√©e:', haUrl);
            hideConfigPanel();
            startAutoRefresh();
        }

        function hideConfigPanel() {
            document.getElementById('configPanel').style.display = 'none';
        }

        function showConfigPanel() {
            document.getElementById('configPanel').style.display = 'block';
        }

        // D√©marrage du rafra√Æchissement automatique
        function startAutoRefresh() {
            loadStates();
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            refreshInterval = setInterval(function() {
                loadStates();
            }, 5000); // R√©duit √† 5 secondes pour plus de r√©activit√©
        }

        // Chargement des √©tats depuis Home Assistant
        function loadStates() {
            if (isLoading) return;
            isLoading = true;
            
            var loadingEl = document.getElementById('loading');
            loadingEl.style.display = 'block';
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', haUrl + '/api/states', true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + haToken);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    isLoading = false;
                    loadingEl.style.display = 'none';
                    
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            entities = data;
                            displayStates(data);
                            updateLastRefresh();
                            clearErrors();
                        } catch (e) {
                            console.error('Erreur parsing:', e);
                            showError('Erreur de traitement des donn√©es: ' + e.message);
                        }
                    } else if (xhr.status === 401) {
                        showError('üîê Token invalide - V√©rifiez votre token d\'acc√®s');
                        showConfigPanel();
                    } else if (xhr.status === 0) {
                        showError('üåê Impossible de se connecter - V√©rifiez votre URL et votre r√©seau');
                    } else {
                        showError('‚ö†Ô∏è Erreur de connexion (Code: ' + xhr.status + ')');
                    }
                }
            };
            
            xhr.onerror = function() {
                isLoading = false;
                loadingEl.style.display = 'none';
                showError('üîå Erreur r√©seau - V√©rifiez votre connexion Internet');
            };
            
            try {
                xhr.send();
            } catch (e) {
                isLoading = false;
                loadingEl.style.display = 'none';
                showError('Erreur lors de l\'envoi de la requ√™te');
            }
        }

        // Affichage des √©tats
        function displayStates(states) {
            var content = document.getElementById('content');
            var html = '';
            
            // Tri et organisation des entit√©s
            var lights = [];
            var switches = [];
            var climates = [];
            var sensors = [];
            var covers = [];
            
            for (var i = 0; i < states.length; i++) {
                var entity = states[i];
                var domain = entity.entity_id.split('.')[0];
                
                switch (domain) {
                    case 'light':
                        lights.push(entity);
                        break;
                    case 'switch':
                        switches.push(entity);
                        break;
                    case 'climate':
                        climates.push(entity);
                        break;
                    case 'cover':
                        covers.push(entity);
                        break;
                    case 'sensor':
                    case 'binary_sensor':
                        if (entity.attributes.device_class === 'temperature' || 
                            entity.attributes.device_class === 'humidity' ||
                            entity.entity_id.indexOf('temperature') !== -1 ||
                            entity.entity_id.indexOf('humidite') !== -1) {
                            sensors.push(entity);
                        }
                        break;
                }
            }
            
            // Affichage des sections avec r√©partition optimis√©e
            if (climates.length > 0) {
                html += createSection('üå°Ô∏è Climatisation', climates, true, 'climate');
            }
            
            if (lights.length > 0) {
                html += createSection('üí° √âclairages', lights.slice(0, 12), true, 'light');
            }
            
            if (switches.length > 0) {
                html += createSection('üîå Interrupteurs', switches.slice(0, 10), true, 'switch');
            }
            
            if (covers.length > 0) {
                html += createSection('ü™ü Volets', covers.slice(0, 8), true, 'cover');
            }
            
            if (sensors.length > 0) {
                html += createSection('üìä Capteurs', sensors.slice(0, 8), false, 'sensor');
            }
            
            content.innerHTML = html;
        }

        // Cr√©ation d'une section
        function createSection(title, entities, controllable, type) {
            var html = '<div class="section">';
            html += '<h3>' + title + ' <span class="section-count">' + entities.length + '</span></h3>';
            
            for (var i = 0; i < entities.length; i++) {
                html += createEntityHtml(entities[i], controllable, type);
            }
            
            html += '</div>';
            return html;
        }

        // Cr√©ation du HTML pour une entit√©
        function createEntityHtml(entity, controllable, type) {
            var friendlyName = entity.attributes.friendly_name || entity.entity_id;
            var state = entity.state;
            var unit = entity.attributes.unit_of_measurement || '';
            var entityId = entity.entity_id;
            
            // Statut indicator
            var statusClass = 'status-unavailable';
            if (state === 'on') statusClass = 'status-on';
            else if (state === 'off') statusClass = 'status-off';
            else if (state === 'unavailable') statusClass = 'status-unavailable';
            
            var updatingClass = pendingCommands.has(entityId) ? ' updating' : '';
            
            var html = '<div class="entity' + updatingClass + '" data-entity-id="' + entityId + '">';
            html += '<div class="entity-info">';
            html += '<div class="entity-name">';
            html += '<span class="status-indicator ' + statusClass + '"></span>';
            html += friendlyName + '</div>';
            
            if (type === 'climate') {
                var currentTemp = entity.attributes.current_temperature;
                var targetTemp = entity.attributes.temperature;
                html += '<div class="entity-state">√âtat: ' + translateState(state) + '</div>';
                if (currentTemp && targetTemp) {
                    html += '<div class="climate-info">';
                    html += '<span class="climate-temp">Actuel: ' + currentTemp + '¬∞C</span>';
                    html += '<span class="climate-temp">Cible: ' + targetTemp + '¬∞C</span>';
                    html += '</div>';
                }
            } else {
                html += '<div class="entity-state">' + translateState(state) + ' ' + unit + '</div>';
            }
            
            html += '</div>';
            
            // Boutons de contr√¥le
            if (controllable) {
                if (type === 'cover') {
                    html += '<div class="cover-controls">';
                    html += '<button class="control-btn" onclick="controlCover(\'' + entityId + '\', \'open_cover\')">‚¨Ü</button>';
                    html += '<button class="control-btn" onclick="controlCover(\'' + entityId + '\', \'stop_cover\')">‚è∏</button>';
                    html += '<button class="control-btn" onclick="controlCover(\'' + entityId + '\', \'close_cover\')">‚¨á</button>';
                    html += '</div>';
                } else if (state === 'on' || state === 'off') {
                    var buttonClass = state === 'on' ? 'control-btn' : 'control-btn off';
                    var buttonText = state === 'on' ? 'OFF' : 'ON';
                    var disabled = pendingCommands.has(entityId) ? ' disabled' : '';
                    html += '<button class="' + buttonClass + '"' + disabled + ' onclick="toggleEntity(\'' + entityId + '\')">' + buttonText + '</button>';
                }
            }
            
            html += '</div>';
            return html;
        }

        // Traduction des √©tats
        function translateState(state) {
            var translations = {
                'on': 'Allum√©',
                'off': '√âteint',
                'unavailable': 'Indisponible',
                'unknown': 'Inconnu',
                'open': 'Ouvert',
                'closed': 'Ferm√©',
                'opening': 'Ouverture...',
                'closing': 'Fermeture...',
                'heat': 'Chauffage',
                'cool': 'Climatisation',
                'auto': 'Auto',
                'idle': 'Inactif'
            };
            return translations[state] || state;
        }

        // Contr√¥le des entit√©s avec feedback am√©lior√©
        function toggleEntity(entityId) {
            if (pendingCommands.has(entityId)) return;
            
            var entity = findEntity(entityId);
            if (!entity) return;
            
            var service = entity.state === 'on' ? 'turn_off' : 'turn_on';
            var domain = entityId.split('.')[0];
            
            // Marquer comme en cours de traitement
            pendingCommands.add(entityId);
            updateEntityUI(entityId, true);
            
            callService(domain, service, { entity_id: entityId }, entityId);
        }

        // Contr√¥le des volets am√©lior√©
        function controlCover(entityId, action) {
            if (pendingCommands.has(entityId)) return;
            
            pendingCommands.add(entityId);
            updateEntityUI(entityId, true);
            
            callService('cover', action, { entity_id: entityId }, entityId);
        }

        // Mise √† jour de l'UI pour une entit√©
        function updateEntityUI(entityId, isUpdating) {
            var entityEl = document.querySelector('[data-entity-id="' + entityId + '"]');
            if (entityEl) {
                if (isUpdating) {
                    entityEl.classList.add('updating');
                    var btn = entityEl.querySelector('.control-btn');
                    if (btn) btn.disabled = true;
                } else {
                    entityEl.classList.remove('updating');
                    var btn = entityEl.querySelector('.control-btn');
                    if (btn) btn.disabled = false;
                }
            }
        }

        // Appel de service Home Assistant am√©lior√©
        function callService(domain, service, data, entityId) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', haUrl + '/api/services/' + domain + '/' + service, true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + haToken);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    // Supprimer de la liste des commandes en cours
                    pendingCommands.delete(entityId);
                    updateEntityUI(entityId, false);
                    
                    if (xhr.status === 200) {
                        // Feedback visuel de succ√®s
                        showSuccess('‚úÖ Commande ex√©cut√©e avec succ√®s');
                        // Rafra√Æchir apr√®s un court d√©lai
                        setTimeout(function() {
                            loadStates();
                        }, 1000);
                    } else {
                        showError('‚ùå Erreur lors du contr√¥le de l\'√©quipement (Code: ' + xhr.status + ')');
                        // Rafra√Æchir quand m√™me pour r√©cup√©rer l'√©tat r√©el
                        setTimeout(function() {
                            loadStates();
                        }, 1000);
                    }
                }
            };
            
            xhr.onerror = function() {
                pendingCommands.delete(entityId);
                updateEntityUI(entityId, false);
                showError('‚ùå Erreur r√©seau lors du contr√¥le');
            };
            
            try {
                xhr.send(JSON.stringify(data));
            } catch (e) {
                pendingCommands.delete(entityId);
                updateEntityUI(entityId, false);
                showError('‚ùå Erreur lors de l\'envoi de la commande');
            }
        }

        // Recherche d'une entit√©
        function findEntity(entityId) {
            for (var i = 0; i < entities.length; i++) {
                if (entities[i].entity_id === entityId) {
                    return entities[i];
                }
            }
            return null;
        }

        // Affichage des erreurs
        function showError(message) {
            var content = document.getElementById('content');
            var errorHtml = '<div class="error">' + message + '</div>';
            if (content.innerHTML) {
                content.innerHTML = errorHtml + content.innerHTML;
            } else {
                content.innerHTML = errorHtml;
            }
            
            // Auto-suppression apr√®s 5 secondes
            setTimeout(clearErrors, 5000);
        }

        // Affichage des messages de succ√®s
        function showSuccess(message) {
            var content = document.getElementById('content');
            var successHtml = '<div class="success-feedback">' + message + '</div>';
            if (content.innerHTML) {
                content.innerHTML = successHtml + content.innerHTML;
            }
            
            // Auto-suppression apr√®s 3 secondes
            setTimeout(function() {
                var success = document.querySelector('.success-feedback');
                if (success) {
                    success.remove();
                }
            }, 3000);
        }

        // Effacement des erreurs
        function clearErrors() {
            var errors = document.getElementsByClassName('error');
            for (var i = errors.length - 1; i >= 0; i--) {
                errors[i].parentNode.removeChild(errors[i]);
            }
        }

        // Mise √† jour de l'heure de rafra√Æchissement
        function updateLastRefresh() {
            var now = new Date();
            var hours = now.getHours();
            var minutes = now.getMinutes();
            var seconds = now.getSeconds();
            
            if (hours < 10) hours = '0' + hours;
            if (minutes < 10) minutes = '0' + minutes;
            if (seconds < 10) seconds = '0' + seconds;
            
            var timeString = hours + ':' + minutes + ':' + seconds;
            document.getElementById('lastUpdate').innerHTML = 'üîÑ Mise √† jour : ' + timeString;
        }

        // Gestion des √©v√©nements tactiles pour iOS
        document.addEventListener('touchstart', function() {}, { passive: true });

        // D√©marrage de l'application
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // Nettoyage √† la fermeture
        window.onbeforeunload = function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        };
    </script>
</body>
</html>