<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>üè† Home Assistant Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/local/icon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, "Helvetica Neue", Helvetica, Arial, sans-serif;
            background: center / cover no-repeat url("/local/fond_tablette.webp") fixed;
            background-color: #333; /* Fallback */
            min-height: 100vh;
            color: white;
            padding: 8px;
            -webkit-text-size-adjust: none;
        }

        .header {
            display: none; /* Remplac√© par la nouvelle carte header */
        }

        .nav {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.2);
            -webkit-border-radius: 12px;
            border-radius: 12px;
            padding: 5px;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: white;
            padding: 10px 15px;
            font-size: 0.9em;
            font-weight: 600;
            -webkit-border-radius: 8px;
            border-radius: 8px;
            -webkit-transition: background 0.3s ease;
            -o-transition: background 0.3s ease;
            transition: background 0.3s ease;
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .page { display: none; }
        .page.active { display: block; }

        #accueil-grid {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-flex-wrap: wrap;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            gap: 10px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            -webkit-border-radius: 12px;
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            -webkit-box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            width: 100%;
        }

        .card-title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        /* Layout pour tablettes en paysage */
        @media (orientation: landscape) and (min-width: 768px) {
            #accueil-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: auto;
                gap: 15px;
            }
            #header-card { grid-column: 1 / -1; }
            #weather-card { grid-column: 1 / 2; }
            #climate-card { grid-column: 2 / 4; }
            #pieces-card { grid-column: 1 / 2; }
            #materiel-card { grid-column: 2 / 3; }
            #scenarios-card { grid-column: 3 / 4; }
        }

        /* ---- Styles des cartes sp√©cifiques ---- */
        #header-card-content {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-align-items: center;
            align-items: center;
        }
        #header-card-content h2 { font-size: 1.4em; margin:0; }
        #header-card-content p { font-size: 0.9em; margin:0; opacity: 0.8; }
        #header-card-info { font-size: 0.85em; font-weight: bold; }

        .climate-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        .climate-item { text-align: center; }
        .climate-item .name { font-size: 0.9em; font-weight: bold; }
        .climate-item .state { font-size: 0.8em; opacity: 0.8; }
        .climate-item .temp { font-size: 1.2em; font-weight: bold; }

        .button-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .styled-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 8px;
            font-size: 0.9em;
            font-weight: 700;
            -webkit-border-radius: 10px;
            border-radius: 10px;
            text-align: center;
            height: 60px;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-transition: background 0.3s ease;
            transition: background 0.3s ease;
        }
        .styled-btn:active { background: rgba(255, 255, 255, 0.3); }
        .styled-btn .icon { margin-right: 8px; }

        .piece-btn { background: -webkit-linear-gradient(135deg, rgba(21,101,192,0.7), rgba(25,118,210,0.6)); }
        .materiel-btn { background: -webkit-linear-gradient(135deg, rgba(245,127,23,0.7), rgba(255,152,0,0.6)); }
        .scenario-btn { background: -webkit-linear-gradient(135deg, rgba(156,39,176,0.7), rgba(233,30,99,0.6)); }

        .config-panel {
            background: rgba(0,0,0,0.7);
            -webkit-border-radius: 12px;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        .config-panel h3 { color: white; }
        .config-panel input {
            width: 100%; padding: 12px; margin: 6px 0;
            border: 1px solid rgba(255,255,255,0.3);
            -webkit-border-radius: 6px; border-radius: 6px;
            font-size: 1em; -webkit-appearance: none;
            background: rgba(255,255,255,0.1); color: white;
        }
        .config-panel button {
            background: -webkit-linear-gradient(45deg, #667eea, #764ba2);
            color: white; border: none; padding: 12px 20px;
            -webkit-border-radius: 20px; border-radius: 20px;
            font-weight: 600; margin-top: 10px; width: 100%; font-size: 1em;
        }

        .loading { text-align: center; color: white; padding: 30px; font-size: 1.1em; }
        .error { background: #d32f2f; color: white; padding: 12px; -webkit-border-radius: 8px; border-radius: 8px; margin: 10px 0; }
        .last-update { text-align: center; color: rgba(255,255,255,0.7); font-size: 0.8em; margin-top: 15px; padding: 10px; }

        /* Fallback pour ancien iOS sans support de backdrop-filter */
        @supports not ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) {
          .card {
            background: rgba(0, 0, 0, 0.3);
          }
        }

        .entity-row {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-align-items: center;
            align-items: center;
            padding: 8px 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .entity-row:last-child {
            border-bottom: none;
        }
        .entity-info {
            -webkit-flex-grow: 1;
            flex-grow: 1;
        }
        .entity-name {
            font-weight: 600;
        }
        .entity-state {
            font-size: 0.85em;
            opacity: 0.7;
        }
        .entity-controls button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 10px;
            font-size: 0.8em;
            -webkit-border-radius: 6px;
            border-radius: 6px;
            margin-left: 5px;
        }
        .entity-controls button.active {
            background: #667eea;
        }
    </style>
</head>
<body>
    <div class="config-panel" id="configPanel">
        <h3>‚öôÔ∏è Configuration</h3>
        <input type="text" id="haUrl" placeholder="URL Home Assistant" autocomplete="off" />
        <input type="password" id="haToken" placeholder="Token d'acc√®s" autocomplete="off" />
        <button onclick="saveConfig()">Se connecter</button>
    </div>

    <div id="dashboard-content" style="display: none;">
        <div class="nav">
            <button class="nav-btn active" onclick="showPage('page-accueil')">Accueil</button>
            <button class="nav-btn" onclick="showPage('page-pieces')">Pi√®ces</button>
            <button class="nav-btn" onclick="showPage('page-materiel')">Mat√©riel</button>
        </div>

        <div id="main-content">
            <div id="page-accueil" class="page active">
                <div id="accueil-grid">
                    <div id="header-card" class="card"></div>
                    <div id="weather-card" class="card"></div>
                    <div id="climate-card" class="card"></div>
                    <div id="pieces-card" class="card"></div>
                    <div id="materiel-card" class="card"></div>
                    <div id="scenarios-card" class="card"></div>
                </div>
            </div>
            <div id="page-pieces" class="page">
                <div class="dashboard-grid" id="pieces-grid"></div>
            </div>
            <div id="page-materiel" class="page">
                <div class="dashboard-grid" id="materiel-grid"></div>
            </div>
        </div>
        <div class="last-update" id="lastUpdate"></div>
    </div>

    <div class="loading" id="loading" style="display: none;">
        <div>üîÑ Connexion en cours...</div>
    </div>

    <script>
        var haUrl = '', haToken = '', entities = [], refreshInterval, isLoading = false;

        function initApp() {
            if (haUrl && haToken) {
                hideConfigPanel();
                startAutoRefresh();
            }
        }

        function showPage(pageId) {
            var pages = document.getElementsByClassName('page');
            for (var i = 0; i < pages.length; i++) pages[i].classList.remove('active');
            document.getElementById(pageId).classList.add('active');

            var navBtns = document.getElementsByClassName('nav-btn');
            for (var i = 0; i < navBtns.length; i++) navBtns[i].classList.remove('active');
            
            var activeBtn = document.querySelector('.nav-btn[onclick="showPage(\'' + pageId + '\')]');
            if (activeBtn) activeBtn.classList.add('active');
            
            if (entities.length > 0) displayStates(entities);
        }

        function saveConfig() {
            haUrl = document.getElementById('haUrl').value.replace(/\s/g, '');
            haToken = document.getElementById('haToken').value.replace(/\s/g, '');
            if (!haUrl || !haToken) { showError('URL et Token requis.'); return; }
            if (haUrl.slice(-1) === '/') haUrl = haUrl.slice(0, -1);
            if (haUrl.indexOf('http') !== 0) haUrl = 'http://' + haUrl;
            hideConfigPanel();
            startAutoRefresh();
        }

        function hideConfigPanel() {
            document.getElementById('configPanel').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            showPage('page-accueil');
        }

        function startAutoRefresh() {
            loadStates();
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(loadStates, 10000);
        }

        function loadStates() {
            if (isLoading) return;
            isLoading = true;
            document.getElementById('loading').style.display = 'block';
            
            callApi('GET', '/states', null, function(status, responseText) {
                isLoading = false;
                document.getElementById('loading').style.display = 'none';
                if (status === 200) {
                    try {
                        entities = JSON.parse(responseText);
                        displayStates(entities);
                        updateLastRefresh();
                    } catch (e) { showError('Erreur de parsing JSON.'); }
                } else {
                    showError('Erreur de connexion: ' + status);
                }
            });
        }

        function displayStates(states) {
            var currentPageId = document.querySelector('.page.active').id;
            if (currentPageId === 'page-accueil') {
                displayAccueil(states);
            } else if (currentPageId === 'page-pieces') {
                displayPieces(states);
            } else if (currentPageId === 'page-materiel') {
                displayMateriel(states);
            }
        }

        function displayAccueil(states) {
            // ... (same as before)
        }

        function displayMateriel(states) {
            var grid = document.getElementById('materiel-grid');
            var domains = ['light', 'switch', 'cover', 'climate', 'sensor'];
            var html = '';

            domains.forEach(function(domain) {
                var domainEntities = findEntityByDomain(states, domain);
                if (domainEntities.length > 0) {
                    html += '<div class="card"><h3 class="card-title">' + domain.charAt(0).toUpperCase() + domain.slice(1) + 's</h3>';
                    domainEntities.forEach(function(entity) {
                        html += createEntityRowHtml(entity);
                    });
                    html += '</div>';
                }
            });
            grid.innerHTML = html;
        }

        function displayPieces(states) {
            var grid = document.getElementById('pieces-grid');
            var rooms = {};
            
            states.forEach(function(entity) {
                var roomName = (entity.attributes.friendly_name || '').split(' ')[0];
                if (['Salon', 'Cuisine', 'Chambre', 'Bureau', 'Salle', 'Entr√©e'].indexOf(roomName) !== -1) {
                    if (!rooms[roomName]) rooms[roomName] = [];
                    rooms[roomName].push(entity);
                }
            });

            var html = '';
            for (var room in rooms) {
                html += '<div class="card"><h3 class="card-title">' + room + '</h3>';
                rooms[room].forEach(function(entity) {
                    html += createEntityRowHtml(entity);
                });
                html += '</div>';
            }
            grid.innerHTML = html;
        }

        function createEntityRowHtml(entity) {
            var domain = entity.entity_id.split('.')[0];
            var html = '<div class="entity-row">';
            html += '<div class="entity-info">' +
                        '<div class="entity-name">' + (entity.attributes.friendly_name || entity.entity_id) + '</div>' +
                        '<div class="entity-state">' + entity.state + '</div>' +
                    '</div>';
            html += '<div class="entity-controls">';

            if (domain === 'light' || domain === 'switch') {
                var isOn = entity.state === 'on';
                html += '<button class="' + (isOn ? 'active' : '') + '" onclick="toggleEntity(\'' + entity.entity_id + '\')">' + (isOn ? '√âteindre' : 'Allumer') + '</button>';
            } else if (domain === 'cover') {
                html += '<button onclick="controlCover(\'' + entity.entity_id + '\', \'open_cover\')">‚¨Ü</button>';
                html += '<button onclick="controlCover(\'' + entity.entity_id + '\', \'stop_cover\')">‚è∏</button>';
                html += '<button onclick="controlCover(\'' + entity.entity_id + '\', \'close_cover\')">‚¨á</button>';
            }

            html += '</div></div>';
            return html;
        }

        function toggleEntity(entityId) {
            var entity = findEntity(entities, entityId);
            if (!entity) return;
            var service = entity.state === 'on' ? 'turn_off' : 'turn_on';
            var domain = entityId.split('.')[0];
            callService(domain, service, { entity_id: entityId });
        }

        function controlCover(entityId, service) {
            callService('cover', service, { entity_id: entityId });
        }

        function createButton(name, icon, btnClass, action) {
            return '<button class="styled-btn ' + btnClass + '" onclick="' + action + '">' +
                   '<span class="icon"></span>' + name + '</button>';
        }

        function callApi(method, path, body, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open(method, haUrl + '/api' + path, true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + haToken);
            if (body) xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    callback(xhr.status, xhr.responseText);
                }
            };
            xhr.onerror = function() { callback(0, null); };
            xhr.send(body ? JSON.stringify(body) : null);
        }

        function callService(domain, service, data) {
            callApi('POST', '/services/' + domain + '/' + service, data, function(status, response) {
                if (status !== 200) showError('Erreur service ' + service);
                setTimeout(loadStates, 500); // Fast refresh after action
            });
        }

        function callScript(scriptId) {
            callService('script', scriptId, {});
        }

        function findEntity(states, entityId) {
            for (var i=0; i<states.length; i++) {
                if (states[i].entity_id === entityId) return states[i];
            }
            return null;
        }

        function findEntityByDomain(states, domain) {
            var results = [];
            for (var i=0; i<states.length; i++) {
                if (states[i].entity_id.startsWith(domain + '.')) {
                    results.push(states[i]);
                }
            }
            return results;
        }

        function showError(message) {
            var errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerText = message;
            document.body.appendChild(errorDiv);
            setTimeout(function() { errorDiv.remove(); }, 5000);
        }

        function updateLastRefresh() {
            var timeString = new Date().toLocaleTimeString('fr-FR');
            document.getElementById('lastUpdate').innerHTML = 'üîÑ Mise √† jour : ' + timeString;
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>