<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>üè† Home Assistant Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * {
            margin: 0;
            padding: 0;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, "Helvetica Neue", Helvetica, Arial, sans-serif;
            background: -webkit-linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 8px;
            -webkit-text-size-adjust: none;
            /* Optimisations pour iPad Kiosk - Suppression des zooms et interactions ind√©sirables */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 15px;
            padding: 8px;
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 300;
            margin-bottom: 3px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header-info {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* iPad Mini et tablettes en paysage - conditions plus sp√©cifiques */
        @media (min-width: 768px) and (orientation: landscape) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            body {
                padding: 12px;
            }
        }

        /* iPad standard et plus grand */
        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr 1fr 1fr;
                gap: 18px;
            }
            
            body {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            -webkit-border-radius: 12px;
            border-radius: 12px;
            padding: 12px;
            -webkit-box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            break-inside: avoid;
        }

        .section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1em;
            font-weight: 600;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-count {
            background: #667eea;
            color: white;
            font-size: 0.75em;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 500;
        }

        .entity {
            background: #f8f9fa;
            -webkit-border-radius: 8px;
            border-radius: 8px;
            padding: 8px 10px;
            margin: 6px 0;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-align-items: center;
            align-items: center;
            -webkit-transition: all 0.3s ease;
            transition: all 0.3s ease;
            position: relative;
            min-height: 50px;
        }

        .entity:active {
            background: #e9ecef;
            /* Suppression du zoom sur iPad */
        }

        .entity.updating {
            opacity: 0.7;
            pointer-events: none;
        }

        .entity.updating::after {
            content: "üîÑ";
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: translateY(-50%) rotate(0deg); }
            to { transform: translateY(-50%) rotate(360deg); }
        }

        .entity-info {
            -webkit-flex: 1;
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .entity-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
            font-size: 0.85em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
        }

        .entity-state {
            color: #666;
            font-size: 0.75em;
            line-height: 1.2;
        }

        .control-btn {
            background: -webkit-linear-gradient(45deg, #4CAF50, #45a049);
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 10px 18px;
            -webkit-border-radius: 25px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.8em;
            -webkit-transition: all 0.3s ease;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            outline: none;
            min-width: 60px;
            min-height: 40px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
        }

        .control-btn:active {
            /* Suppression du zoom - remplac√© par changement de couleur */
            background: -webkit-linear-gradient(45deg, #45a049, #3d8b40);
            background: linear-gradient(45deg, #45a049, #3d8b40);
        }

        .control-btn:hover {
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .control-btn.off {
            background: -webkit-linear-gradient(45deg, #f44336, #d32f2f);
            background: linear-gradient(45deg, #f44336, #d32f2f);
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.2);
        }

        .control-btn.off:hover {
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }

        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .cover-controls {
            display: flex;
            gap: 6px;
        }

        .cover-controls .control-btn {
            padding: 8px 12px;
            font-size: 0.75em;
            min-width: 40px;
            min-height: 35px;
        }

        .config-panel {
            background: rgba(255, 255, 255, 0.95);
            -webkit-border-radius: 12px;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .config-panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .config-panel input {
            width: 100%;
            padding: 12px;
            margin: 6px 0;
            border: 2px solid #e9ecef;
            -webkit-border-radius: 6px;
            border-radius: 6px;
            font-size: 1em;
            -webkit-appearance: none;
            background: white;
        }

        .config-panel input:focus {
            outline: none;
            border-color: #667eea;
        }

        .config-panel button {
            background: -webkit-linear-gradient(45deg, #667eea, #764ba2);
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            -webkit-border-radius: 20px;
            border-radius: 20px;
            font-weight: 600;
            margin-top: 10px;
            width: 100%;
            font-size: 1em;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 30px;
            font-size: 1.1em;
        }

        .error {
            background: rgba(244, 67, 54, 0.1);
            color: #d32f2f;
            padding: 12px;
            -webkit-border-radius: 8px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #f44336;
            font-size: 0.9em;
        }

        .last-update {
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-size: 0.75em;
            margin-top: 10px;
            padding: 8px;
            grid-column: 1 / -1;
        }

        .climate-info {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            margin-top: 3px;
            gap: 8px;
        }

        .climate-temp {
            font-size: 0.7em;
            color: #2980b9;
            font-weight: 600;
            background: rgba(41, 128, 185, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            -webkit-border-radius: 50%;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            flex-shrink: 0;
        }

        .status-on { background: #4CAF50; }
        .status-off { background: #f44336; }
        .status-unavailable { background: #9e9e9e; }

        .success-feedback {
            background: rgba(76, 175, 80, 0.1);
            color: #2e7d32;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            margin-top: 5px;
            border-left: 3px solid #4CAF50;
        }

        /* Navigation principale */
        .main-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            border-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }

        /* Pages */
        .page-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Grilles pour les pages */
        .rooms-grid, .material-grid, .scenarios-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        @media (min-width: 768px) and (orientation: landscape) {
            .rooms-grid, .material-grid, .scenarios-grid {
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
        }

        @media (min-width: 1024px) {
            .rooms-grid, .material-grid, .scenarios-grid {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 25px;
            }
        }

        /* Cartes de pi√®ces, mat√©riel et sc√©narios */
        .room-card, .material-card, .scenario-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            /* Optimisations iPad Kiosk */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .room-card:hover, .material-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.12);
        }

        .room-card:active, .material-card:active {
            /* Suppression du zoom - remplac√© par changement de couleur */
            background: rgba(245, 245, 245, 0.95);
        }

        .room-icon, .material-icon, .scenario-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .room-name, .material-name, .scenario-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .room-info, .material-info, .scenario-info {
            font-size: 0.8em;
            color: #666;
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        /* Styles sp√©cifiques pour les sc√©narios */
        .scenario-card {
            position: relative;
            overflow: hidden;
        }

        .scenario-card.coucher {
            background: linear-gradient(135deg, rgba(63, 81, 181, 0.9), rgba(103, 58, 183, 0.8));
            color: white;
        }

        .scenario-card.absent {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.9), rgba(233, 30, 99, 0.8));
            color: white;
        }

        .scenario-card.fete {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.9), rgba(233, 30, 99, 0.8));
            color: white;
        }

        .scenario-card.film {
            background: linear-gradient(135deg, rgba(0, 150, 136, 0.9), rgba(0, 188, 212, 0.8));
            color: white;
        }

        .scenario-card.nuit {
            background: linear-gradient(135deg, rgba(33, 33, 33, 0.9), rgba(66, 66, 66, 0.8));
            color: white;
        }

        .scenario-card.coucher .scenario-name,
        .scenario-card.absent .scenario-name,
        .scenario-card.fete .scenario-name,
        .scenario-card.film .scenario-name,
        .scenario-card.nuit .scenario-name {
            color: white;
        }

        .scenario-card.coucher .scenario-info,
        .scenario-card.absent .scenario-info,
        .scenario-card.fete .scenario-info,
        .scenario-card.film .scenario-info,
        .scenario-card.nuit .scenario-info {
            color: rgba(255, 255, 255, 0.8);
        }

        /* Navigation de retour */
        .back-nav {
            margin: 20px 0;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            border: 2px solid #e9ecef;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .back-btn:hover {
            background: #f8f9fa;
            border-color: #667eea;
            color: #667eea;
        }

        /* D√©tails des pi√®ces */
        .room-details, .material-details {
            margin-top: 20px;
        }

        /* Responsive pour navigation */
        @media (max-width: 480px) {
            .main-nav {
                gap: 5px;
            }
            
            .nav-btn {
                padding: 6px 12px;
                font-size: 0.8em;
            }
            
            .room-card, .material-card {
                min-height: 100px;
                padding: 15px;
            }
            
            .room-icon, .material-icon, .scenario-icon {
                font-size: 2em;
            }
        }

        /* Optimisations globales pour iPad Kiosk */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        button, .nav-btn, .control-btn, .back-btn {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Optimisations pour les petites entit√©s sans contr√¥les */
        .entity.sensor-only {
            min-height: 40px;
            padding: 6px 10px;
        }

        .entity.sensor-only .entity-name {
            font-size: 0.8em;
        }

        .entity.sensor-only .entity-state {
            font-size: 0.7em;
        }

        /* Style pour les valeurs importantes */
        .entity-value {
            font-weight: 600;
            color: #2c3e50;
        }

        /* Adaptation pour les tr√®s petits √©crans */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .control-btn {
                padding: 8px 12px;
                font-size: 0.75em;
                min-width: 50px;
                min-height: 35px;
            }
            
            .entity {
                min-height: 45px;
                padding: 6px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè† Home Assistant</h1>
        <div class="header-info">Tableau de bord connect√©</div>
        <div class="main-nav" id="mainNav">
            <button class="nav-btn active" onclick="showPage('dashboard')">üè† Accueil</button>
            <button class="nav-btn" onclick="showPage('pieces')">üèòÔ∏è Pi√®ces</button>
            <button class="nav-btn" onclick="showPage('materiel')">üîß Mat√©riel</button>
            <button class="nav-btn" onclick="showPage('scenarios')">üé¨ Sc√©narios</button>
        </div>
    </div>

    <!-- Filtres dynamiques -->
    <div class="filter-bar" style="display:flex;justify-content:center;gap:20px;margin-bottom:15px;">
      <div>
        <label for="roomFilter" style="font-size:1.1em;">Pi√®ce :</label>
        <select id="roomFilter" style="font-size:1.1em;padding:6px 12px;border-radius:8px;">
          <option value="all">Toutes</option>
          <option value="adele">Ad√®le</option>
          <option value="alex">Alex</option>
          <option value="bureau">Bureau</option>
          <option value="cuisine">Cuisine</option>
          <option value="entree_tv">Entr√©e & TV</option>
          <option value="parents">Parents</option>
        </select>
      </div>
      <div>
        <label for="materialFilter" style="font-size:1.1em;">Mat√©riel :</label>
        <select id="materialFilter" style="font-size:1.1em;padding:6px 12px;border-radius:8px;">
          <option value="all">Tous</option>
          <option value="volets">Volets</option>
          <option value="temperature">Temp√©rature</option>
          <option value="electromenager">√âlectrom√©nager</option>
          <option value="exterieur">Ext√©rieur</option>
          <option value="reseau">R√©seau</option>
          <option value="imprimante">Imprimante</option>
        </select>
      </div>
    </div>

    <div class="page-content" id="dashboardPage">
        <div class="dashboard-grid" id="content"></div>
        <div class="last-update" id="lastUpdate"></div>
    </div>
    
    <!-- Page Pi√®ces -->
    <div class="page-content" id="piecesPage" style="display: none;">
        <div class="rooms-grid" id="roomsContent"></div>
        <div class="room-details" id="roomDetails" style="display: none;">
            <div class="back-nav">
                <button class="back-btn" onclick="showRoomsList()">‚Üê Retour aux pi√®ces</button>
            </div>
            <div class="dashboard-grid" id="roomEntities"></div>
        </div>
    </div>
    
    <!-- Page Mat√©riel -->
    <div class="page-content" id="materielPage" style="display: none;">
        <div class="material-grid" id="materialContent"></div>
        <div class="material-details" id="materialDetails" style="display: none;">
            <div class="back-nav">
                <button class="back-btn" onclick="showMaterialList()">‚Üê Retour au mat√©riel</button>
            </div>
            <div class="dashboard-grid" id="materialEntities"></div>
        </div>
    </div>
    
    <!-- Page Sc√©narios -->
    <div class="page-content" id="scenariosPage" style="display: none;">
        <div class="scenarios-grid" id="scenariosContent"></div>
    </div>

    <script>
        // Variables globales
        var haUrl = '';
        var haToken = '';
        var entities = [];
        var refreshInterval;
        var isLoading = false;
        var pendingCommands = new Set();
        var currentPage = 'dashboard';
        var currentRoom = null;
        var currentMaterial = null;

        // Configuration des pi√®ces (bas√©e sur votre YAML)
        var roomsConfig = {
            'adele': { name: 'üëß Ad√®le', entities: ['climate.adele', 'cover.fenetre_adele_arriere', 'cover.fenetre_adele_ru', 'sensor.adele_temperature', 'sensor.adele_humidite', 'binary_sensor.adele_probleme'] },
            'alex': { name: 'üë¶ Alex', entities: ['climate.alex', 'cover.fenetre_alex_jar', 'cover.fenetre_alex_rue', 'sensor.alex_temperature', 'sensor.alex_humidite', 'binary_sensor.alex_probleme'] },
            'bureau': { name: 'üíº Bureau', entities: ['climate.bureau', 'cover.fenetre_bureau', 'sensor.bureau_temperature', 'sensor.bureau_humidite', 'binary_sensor.bureau_probleme'] },
            'cuisine': { name: 'üç≥ Cuisine', entities: ['climate.cuisine', 'cover.fenetre_cuisine', 'cover.fenetre_cuisine_avant', 'sensor.cuisine_temperature', 'sensor.cuisine_humidite', 'binary_sensor.cuisine_probleme'] },
            'entree_tv': { name: 'üì∫ Entr√©e & TV', entities: ['climate.entree_tv', 'cover.fenetre_entree', 'cover.fenetre_salon_central', 'cover.fenetre_salon_dr', 'cover.fenetre_salon_gauche', 'cover.fenetre_salon_tv', 'sensor.entree_tv_temperature', 'sensor.entree_tv_humidite', 'binary_sensor.entree_tv_probleme'] },
            'parents': { name: 'üõèÔ∏è Parents', entities: ['climate.parents', 'cover.fenetre_sdb_suite', 'cover.fenetre_suite', 'sensor.parents_temperature', 'sensor.parents_humidite', 'binary_sensor.parents_probleme'] }
        };

        // Configuration du mat√©riel (bas√©e sur votre YAML)
        var materialConfig = {
            'volets': { name: 'ü™ü Volets', entities: ['cover.tous_les_volets', 'cover.volets_rdc_2', 'cover.volets_chambres_2', 'cover.fenetre_adele_arriere', 'cover.fenetre_adele_ru', 'cover.fenetre_alex_jar', 'cover.fenetre_alex_rue', 'cover.fenetre_bureau', 'cover.fenetre_cuisine', 'cover.fenetre_cuisine_avant', 'cover.fenetre_entree', 'cover.fenetre_salon_central', 'cover.fenetre_salon_dr', 'cover.fenetre_salon_gauche', 'cover.fenetre_salon_tv', 'cover.fenetre_sdb_suite', 'cover.fenetre_suite'] },
            'temperature': { name: 'üå°Ô∏è Temp√©rature', entities: ['sensor.adele_temperature', 'sensor.alex_temperature', 'sensor.bureau_temperature', 'sensor.cuisine_temperature', 'sensor.entree_tv_temperature', 'sensor.parents_temperature', 'weather.forecast_maison'] },
            'electromenager': { name: 'üîå √âlectrom√©nager', entities: ['switch.lave_vaisselle_etat', 'sensor.lave_vaisselle_etat', 'sensor.lave_vaisselle_porte', 'switch.table_de_cuisson_etat', 'switch.table_de_cuisson_securite_enfant', 'sensor.table_de_cuisson_etat'] },
            'exterieur': { name: 'üåø Ext√©rieur', entities: ['binary_sensor.irrigation_unlimited_c1_m', 'binary_sensor.irrigation_unlimited_c1_z1', 'binary_sensor.irrigation_unlimited_c1_z2', 'binary_sensor.irrigation_unlimited_c1_z3', 'weather.forecast_maison'] },
            'reseau': { name: 'üì∂ R√©seau', entities: ['device_tracker.freebox_v9_r1', 'sensor.freebox_download_speed', 'sensor.freebox_upload_speed', 'sensor.freebox_temperature_cpu_0', 'device_tracker.imx6ull14x14evk', 'device_tracker.iphone_9', 'device_tracker.samsung'] },
            'imprimante': { name: 'üñ®Ô∏è Imprimante', entities: ['sensor.hp_deskjet_3700_series', 'sensor.hp_deskjet_3700_series_black_ink', 'sensor.hp_deskjet_3700_series_tri_color_ink'] }
        };

        // Configuration des sc√©narios (bas√©e sur votre YAML)
        var scenariosConfig = {
            'coucher': { name: 'üò¥ Coucher', icon: 'üåô', service: 'script.scenario_coucher', description: 'Mode nuit avec √©clairage tamis√©', class: 'coucher' },
            'absent': { name: 'üè† Absent', icon: 'üö™', service: 'script.scenario_absent', description: 'S√©curisation de la maison', class: 'absent' },
            'fete': { name: 'üéâ F√™te', icon: 'üéä', service: 'script.scenario_fete', description: 'Ambiance festive', class: 'fete' },
            'film': { name: 'üé• Soir√©e Film', icon: 'üçø', service: 'script.scenario_soiree_film', description: 'Ambiance cin√©ma', class: 'film' },
            'nuit': { name: 'üåå Nuit', icon: 'üò¥', service: 'script.scenario_nuit', description: 'Extinction compl√®te', class: 'nuit' }
        };

        // Initialisation au chargement de la page
        function initApp() {
            loadStoredConfig();
            if (haUrl && haToken) {
                hideConfigPanel();
                startAutoRefresh();
            } else {
                showConfigPanel();
                document.getElementById('content').innerHTML = '';
                var filterBar = document.querySelector('.filter-bar');
                if (filterBar) filterBar.style.display = 'none';
            }
        }

        // Chargement de la configuration stock√©e (simulation)
        function loadStoredConfig() {
            // Pour iOS 9.3.5, on ne peut pas utiliser localStorage de mani√®re fiable
            // La configuration devra √™tre saisie √† chaque fois
        }

        // Sauvegarde de la configuration
        // Correction de la logique de connexion pour compatibilit√© iOS 9.3.5
        function saveConfig() {
            var urlInput = document.getElementById('haUrl');
            var tokenInput = document.getElementById('haToken');
            haUrl = urlInput.value.replace(/\s/g, '');
            haToken = tokenInput.value.replace(/\s/g, '');
            if (!haUrl || !haToken) {
                showError('Veuillez remplir tous les champs de configuration');
                return;
            }
            if (haUrl.charAt(haUrl.length - 1) === '/') {
                haUrl = haUrl.slice(0, -1);
            }
            if (haUrl.indexOf('http') !== 0) {
                haUrl = 'http://' + haUrl;
            }
            hideConfigPanel();
            startAutoRefresh();
        }

        function hideConfigPanel() {
            document.getElementById('configPanel').style.display = 'none';
        }

        function showConfigPanel() {
            document.getElementById('configPanel').style.display = 'block';
        }

        // D√©marrage du rafra√Æchissement automatique
        // Correction du refresh pour ne pas masquer le dashboard si la connexion est OK
        function startAutoRefresh() {
            loadStates();
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            refreshInterval = setInterval(function() {
                loadStates();
            }, 8000);
        }

        // Navigation entre les pages
        function showPage(page) {
            // Masquer toutes les pages
            document.getElementById('dashboardPage').style.display = 'none';
            document.getElementById('piecesPage').style.display = 'none';
            document.getElementById('materielPage').style.display = 'none';
            document.getElementById('scenariosPage').style.display = 'none';
            
            // R√©initialiser les d√©tails
            document.getElementById('roomDetails').style.display = 'none';
            document.getElementById('materialDetails').style.display = 'none';
            
            // Mettre √† jour la navigation
            var navBtns = document.querySelectorAll('.nav-btn');
            for (var i = 0; i < navBtns.length; i++) {
                navBtns[i].classList.remove('active');
            }
            
            currentPage = page;
            
            // Afficher la page demand√©e
            if (page === 'dashboard') {
                document.getElementById('dashboardPage').style.display = 'block';
                navBtns[0].classList.add('active');
            } else if (page === 'pieces') {
                document.getElementById('piecesPage').style.display = 'block';
                navBtns[1].classList.add('active');
                showRoomsList();
            } else if (page === 'materiel') {
                document.getElementById('materielPage').style.display = 'block';
                navBtns[2].classList.add('active');
                showMaterialList();
            } else if (page === 'scenarios') {
                document.getElementById('scenariosPage').style.display = 'block';
                navBtns[3].classList.add('active');
                showScenariosList();
            }
        }

        // Affichage de la liste des pi√®ces
        function showRoomsList() {
            document.getElementById('roomDetails').style.display = 'none';
            var roomsContent = document.getElementById('roomsContent');
            var html = '';
            
            for (var roomId in roomsConfig) {
                var room = roomsConfig[roomId];
                var availableEntities = countAvailableEntities(room.entities);
                
                html += '<div class="room-card" onclick="showRoomDetails(\'' + roomId + '\')">';
                html += '<div class="room-icon">' + room.name.split(' ')[0] + '</div>';
                html += '<div class="room-name">' + room.name.substring(2) + '</div>';
                html += '<div class="room-info">';
                html += '<span>' + availableEntities + ' √©quipements</span>';
                html += '</div>';
                html += '</div>';
            }
            
            roomsContent.innerHTML = html;
        }

        // Affichage des d√©tails d'une pi√®ce
        function showRoomDetails(roomId) {
            currentRoom = roomId;
            var room = roomsConfig[roomId];
            
            // Filtrer les entit√©s disponibles
            var roomEntities = [];
            for (var i = 0; i < entities.length; i++) {
                if (room.entities.indexOf(entities[i].entity_id) !== -1) {
                    roomEntities.push(entities[i]);
                }
            }
            
            // Afficher les entit√©s de la pi√®ce
            var roomEntitiesDiv = document.getElementById('roomEntities');
            var html = '<div class="section">';
            html += '<h3>' + room.name + ' <span class="section-count">' + roomEntities.length + '</span></h3>';
            
            for (var i = 0; i < roomEntities.length; i++) {
                var entity = roomEntities[i];
                var domain = entity.entity_id.split('.')[0];
                var controllable = (domain === 'light' || domain === 'switch' || domain === 'cover');
                html += createEntityHtml(entity, controllable, domain);
            }
            
            html += '</div>';
            roomEntitiesDiv.innerHTML = html;
            
            document.getElementById('roomDetails').style.display = 'block';
        }

        // Affichage de la liste du mat√©riel
        function showMaterialList() {
            document.getElementById('materialDetails').style.display = 'none';
            var materialContent = document.getElementById('materialContent');
            var html = '';
            
            for (var materialId in materialConfig) {
                var material = materialConfig[materialId];
                var availableEntities = countAvailableEntities(material.entities);
                
                html += '<div class="material-card" onclick="showMaterialDetails(\'' + materialId + '\')">';
                html += '<div class="material-icon">' + material.name.split(' ')[0] + '</div>';
                html += '<div class="material-name">' + material.name.substring(2) + '</div>';
                html += '<div class="material-info">';
                html += '<span>' + availableEntities + ' √©l√©ments</span>';
                html += '</div>';
                html += '</div>';
            }
            
            materialContent.innerHTML = html;
        }

        // Affichage des d√©tails d'un type de mat√©riel
        function showMaterialDetails(materialId) {
            currentMaterial = materialId;
            var material = materialConfig[materialId];
            
            // Filtrer les entit√©s disponibles
            var materialEntities = [];
            for (var i = 0; i < entities.length; i++) {
                if (material.entities.indexOf(entities[i].entity_id) !== -1) {
                    materialEntities.push(entities[i]);
                }
            }
            
            // Afficher les entit√©s du mat√©riel
            var materialEntitiesDiv = document.getElementById('materialEntities');
            var html = '<div class="section">';
            html += '<h3>' + material.name + ' <span class="section-count">' + materialEntities.length + '</span></h3>';
            
            for (var i = 0; i < materialEntities.length; i++) {
                var entity = materialEntities[i];
                var domain = entity.entity_id.split('.')[0];
                var controllable = (domain === 'light' || domain === 'switch' || domain === 'cover');
                html += createEntityHtml(entity, controllable, domain);
            }
            
            html += '</div>';
            materialEntitiesDiv.innerHTML = html;
            
            document.getElementById('materialDetails').style.display = 'block';
        }

        // Compter les entit√©s disponibles
        function countAvailableEntities(entityList) {
            var count = 0;
            for (var i = 0; i < entities.length; i++) {
                if (entityList.indexOf(entities[i].entity_id) !== -1) {
                    count++;
                }
            }
            return count;
        }

        // Affichage de la liste des sc√©narios
        function showScenariosList() {
            var scenariosContent = document.getElementById('scenariosContent');
            var html = '';
            
            for (var scenarioId in scenariosConfig) {
                var scenario = scenariosConfig[scenarioId];
                
                html += '<div class="scenario-card ' + scenario.class + '" onclick="executeScenario(\'' + scenarioId + '\')">';
                html += '<div class="scenario-icon">' + scenario.icon + '</div>';
                html += '<div class="scenario-name">' + scenario.name + '</div>';
                html += '<div class="scenario-info">';
                html += '<span>' + scenario.description + '</span>';
                html += '</div>';
                html += '</div>';
            }
            
            scenariosContent.innerHTML = html;
        }

        // Ex√©cution d'un sc√©nario
        function executeScenario(scenarioId) {
            var scenario = scenariosConfig[scenarioId];
            
            // Demander confirmation
            if (confirm('Voulez-vous lancer le sc√©nario "' + scenario.name + '" ?\n\n' + scenario.description)) {
                // Appeler le service Home Assistant
                var serviceParts = scenario.service.split('.');
                var domain = serviceParts[0];
                var service = serviceParts[1];
                
                var xhr = new XMLHttpRequest();
                xhr.open('POST', haUrl + '/api/services/' + domain + '/' + service, true);
                xhr.setRequestHeader('Authorization', 'Bearer ' + haToken);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            showSuccess('‚úÖ Sc√©nario "' + scenario.name + '" lanc√© avec succ√®s !');
                        } else {
                            showError('‚ùå Erreur lors du lancement du sc√©nario (Code: ' + xhr.status + ')');
                        }
                    }
                };
                
                xhr.onerror = function() {
                    showError('‚ùå Erreur r√©seau lors du lancement du sc√©nario');
                };
                
                try {
                    xhr.send(JSON.stringify({}));
                } catch (e) {
                    showError('‚ùå Erreur lors de l\'envoi de la commande sc√©nario');
                }
            }
        }

        // Chargement des √©tats depuis Home Assistant
        // Correction du chargement des √©tats pour afficher le dashboard uniquement si la connexion est OK
        function loadStates() {
            if (!haUrl || !haToken) {
                showConfigPanel();
                document.getElementById('content').innerHTML = '';
                var filterBar = document.querySelector('.filter-bar');
                if (filterBar) filterBar.style.display = 'none';
                return;
            }
            if (isLoading) return;
            isLoading = true;
            
            var loadingEl = document.getElementById('loading');
            loadingEl.style.display = 'block';
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', haUrl + '/api/states', true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + haToken);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    isLoading = false;
                    loadingEl.style.display = 'none';
                    
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            entities = data;
                            
                            // Mettre √† jour la page courante
                            if (currentPage === 'dashboard') {
                                displayStates(data);
                            } else if (currentPage === 'pieces' && currentRoom) {
                                showRoomDetails(currentRoom);
                            } else if (currentPage === 'materiel' && currentMaterial) {
                                showMaterialDetails(currentMaterial);
                            }
                            
                            updateLastRefresh();
                            clearErrors();
                        } catch (e) {
                            console.error('Erreur parsing:', e);
                            showError('Erreur de traitement des donn√©es: ' + e.message);
                        }
                    } else if (xhr.status === 401) {
                        showError('üîê Token invalide - V√©rifiez votre token d\'acc√®s');
                        showConfigPanel();
                    } else if (xhr.status === 0) {
                        showError('üåê Impossible de se connecter - V√©rifiez votre URL et votre r√©seau');
                    } else {
                        showError('‚ö†Ô∏è Erreur de connexion (Code: ' + xhr.status + ')');
                    }
                }
            };
            
            xhr.onerror = function() {
                isLoading = false;
                loadingEl.style.display = 'none';
                showError('üîå Erreur r√©seau - V√©rifiez votre connexion Internet');
            };
            
            try {
                xhr.send();
            } catch (e) {
                isLoading = false;
                loadingEl.style.display = 'none';
                showError('Erreur lors de l\'envoi de la requ√™te');
            }
        }

        // Affichage conditionnel du dashboard et des filtres apr√®s connexion
        function displayStates(states) {
            var content = document.getElementById('content');
            var filterBar = document.querySelector('.filter-bar');
            if (!haUrl || !haToken || !entities || entities.length === 0) {
                content.innerHTML = '<div class="error">Veuillez vous connecter pour afficher les outils.</div>';
                if (filterBar) filterBar.style.display = 'none';
                return;
            }
            if (filterBar) filterBar.style.display = 'flex';
            var room = document.getElementById('roomFilter').value;
            var material = document.getElementById('materialFilter').value;
            var html = '';
            var filtered = states.filter(function(entity) {
                var inRoom = (room === 'all') || (entity.attributes.room === room);
                var inMaterial = (material === 'all') || (entity.attributes.material === material);
                return inRoom && inMaterial;
            });
            html += '<div class="dashboard-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;">';
            filtered.forEach(function(entity) {
                html += createEntityHtml(entity, true, entity.entity_id.split('.')[0]);
            });
            html += '</div>';
            content.innerHTML = html;
        }

        // Cr√©ation d'une section
        function createSection(title, entities, controllable, type) {
            var html = '<div class="section">';
            html += '<h3>' + title + ' <span class="section-count">' + entities.length + '</span></h3>';
            
            for (var i = 0; i < entities.length; i++) {
                html += createEntityHtml(entities[i], controllable, type);
            }
            
            html += '</div>';
            return html;
        }

        // Cr√©ation du HTML pour une entit√©
        function createEntityHtml(entity, controllable, type) {
            var friendlyName = entity.attributes.friendly_name || entity.entity_id;
            var state = entity.state;
            var unit = entity.attributes.unit_of_measurement || '';
            var entityId = entity.entity_id;
            var statusClass = 'status-unavailable';
            if (state === 'on') statusClass = 'status-on';
            else if (state === 'off') statusClass = 'status-off';
            else if (state === 'unavailable') statusClass = 'status-unavailable';
            var updatingClass = pendingCommands.has(entityId) ? ' updating' : '';
            var sensorClass = !controllable ? ' sensor-only' : '';
            var html = '<div class="entity' + updatingClass + sensorClass + '" data-entity-id="' + entityId + '">';
            html += '<div class="entity-info">';
            html += '<div class="entity-name">';
            html += '<span class="status-indicator ' + statusClass + '"></span>';
            html += friendlyName + '</div>';
            html += '<div class="entity-state">' + translateState(state) + ' ' + unit + '</div>';
            html += '</div>';
            // Boutons d'action plus grands
            if (controllable) {
                if (type === 'cover') {
                    html += '<div class="cover-controls">';
                    html += '<button class="control-btn" style="font-size:2em;padding:18px 32px;min-width:80px;" onclick="controlCover(\'' + entityId + '\', \'open_cover\')">‚¨Ü</button>';
                    html += '<button class="control-btn" style="font-size:2em;padding:18px 32px;min-width:80px;" onclick="controlCover(\'' + entityId + '\', \'stop_cover\')">‚è∏</button>';
                    html += '<button class="control-btn" style="font-size:2em;padding:18px 32px;min-width:80px;" onclick="controlCover(\'' + entityId + '\', \'close_cover\')">‚¨á</button>';
                    html += '</div>';
                } else if (state === 'on' || state === 'off') {
                    var buttonClass = state === 'on' ? 'control-btn' : 'control-btn off';
                    var buttonText = state === 'on' ? 'OFF' : 'ON';
                    var disabled = pendingCommands.has(entityId) ? ' disabled' : '';
                    html += '<button class="' + buttonClass + '" style="font-size:2em;padding:18px 32px;min-width:80px;"' + disabled + ' onclick="toggleEntity(\'' + entityId + '\')">' + buttonText + '</button>';
                }
            }
            html += '</div>';
            return html;
        }

        // Traduction des √©tats
        function translateState(state) {
            var translations = {
                'on': 'Allum√©',
                'off': '√âteint',
                'unavailable': 'Indisponible',
                'unknown': 'Inconnu',
                'open': 'Ouvert',
                'closed': 'Ferm√©',
                'opening': 'Ouverture...',
                'closing': 'Fermeture...',
                'heat': 'Chauffage',
                'cool': 'Climatisation',
                'auto': 'Auto',
                'idle': 'Inactif'
            };
            return translations[state] || state;
        }

        // Contr√¥le des entit√©s avec feedback am√©lior√©
        function toggleEntity(entityId) {
            if (pendingCommands.has(entityId)) return;
            
            var entity = findEntity(entityId);
            if (!entity) return;
            
            var service = entity.state === 'on' ? 'turn_off' : 'turn_on';
            var domain = entityId.split('.')[0];
            
            // Marquer comme en cours de traitement
            pendingCommands.add(entityId);
            updateEntityUI(entityId, true);
            
            callService(domain, service, { entity_id: entityId }, entityId);
        }

        // Contr√¥le des volets am√©lior√©
        function controlCover(entityId, action) {
            if (pendingCommands.has(entityId)) return;
            
            pendingCommands.add(entityId);
            updateEntityUI(entityId, true);
            
            callService('cover', action, { entity_id: entityId }, entityId);
        }

        // Mise √† jour de l'UI pour une entit√©
        function updateEntityUI(entityId, isUpdating) {
            var entityEl = document.querySelector('[data-entity-id="' + entityId + '"]');
            if (entityEl) {
                if (isUpdating) {
                    entityEl.classList.add('updating');
                    var btn = entityEl.querySelector('.control-btn');
                    if (btn) btn.disabled = true;
                } else {
                    entityEl.classList.remove('updating');
                    var btn = entityEl.querySelector('.control-btn');
                    if (btn) btn.disabled = false;
                }
            }
        }

        // Appel de service Home Assistant am√©lior√©
        function callService(domain, service, data, entityId) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', haUrl + '/api/services/' + domain + '/' + service, true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + haToken);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    // Supprimer de la liste des commandes en cours
                    pendingCommands.delete(entityId);
                    updateEntityUI(entityId, false);
                    
                    if (xhr.status === 200) {
                        // Feedback visuel de succ√®s
                        showSuccess('‚úÖ Commande ex√©cut√©e avec succ√®s');
                        // Rafra√Æchir apr√®s un court d√©lai
                        setTimeout(function() {
                            loadStates();
                        }, 1000);
                    } else {
                        showError('‚ùå Erreur lors du contr√¥le de l\'√©quipement (Code: ' + xhr.status + ')');
                        // Rafra√Æchir quand m√™me pour r√©cup√©rer l'√©tat r√©el
                        setTimeout(function() {
                            loadStates();
                        }, 1000);
                    }
                }
            };
            
            xhr.onerror = function() {
                pendingCommands.delete(entityId);
                updateEntityUI(entityId, false);
                showError('‚ùå Erreur r√©seau lors du contr√¥le');
            };
            
            try {
                xhr.send(JSON.stringify(data));
            } catch (e) {
                pendingCommands.delete(entityId);
                updateEntityUI(entityId, false);
                showError('‚ùå Erreur lors de l\'envoi de la commande');
            }
        }

        // Recherche d'une entit√©
        function findEntity(entityId) {
            for (var i = 0; i < entities.length; i++) {
                if (entities[i].entity_id === entityId) {
                    return entities[i];
                }
            }
            return null;
        }

        // Affichage des erreurs
        function showError(message) {
            var content = document.getElementById('content');
            var errorHtml = '<div class="error">' + message + '</div>';
            if (content.innerHTML) {
                content.innerHTML = errorHtml + content.innerHTML;
            } else {
                content.innerHTML = errorHtml;
            }
            
            // Auto-suppression apr√®s 5 secondes
            setTimeout(clearErrors, 5000);
        }

        // Affichage des messages de succ√®s
        function showSuccess(message) {
            var content = document.getElementById('content');
            var successHtml = '<div class="success-feedback">' + message + '</div>';
            if (content.innerHTML) {
                content.innerHTML = successHtml + content.innerHTML;
            }
            
            // Auto-suppression apr√®s 3 secondes
            setTimeout(function() {
                var success = document.querySelector('.success-feedback');
                if (success) {
                    success.remove();
                }
            }, 3000);
        }

        // Effacement des erreurs
        function clearErrors() {
            var errors = document.getElementsByClassName('error');
            for (var i = errors.length - 1; i >= 0; i--) {
                errors[i].parentNode.removeChild(errors[i]);
            }
        }

        // Mise √† jour de l'heure de rafra√Æchissement
        function updateLastRefresh() {
            var now = new Date();
            var hours = now.getHours();
            var minutes = now.getMinutes();
            var seconds = now.getSeconds();
            
            if (hours < 10) hours = '0' + hours;
            if (minutes < 10) minutes = '0' + minutes;
            if (seconds < 10) seconds = '0' + seconds;
            
            var timeString = hours + ':' + minutes + ':' + seconds;
            document.getElementById('lastUpdate').innerHTML = 'üîÑ Mise √† jour : ' + timeString;
        }

        // Gestion des √©v√©nements tactiles pour iOS - Optimis√© pour iPad Kiosk
        document.addEventListener('touchstart', function() {}, { passive: true });
        
        // Pr√©vention du zoom par pincement sur iPad
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('gesturechange', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('gestureend', function(e) {
            e.preventDefault();
        });

        // D√©marrage de l'application
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // Nettoyage √† la fermeture
        window.onbeforeunload = function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        };

        // Ajout des listeners pour les filtres
        if (document.getElementById('roomFilter')) {
            document.getElementById('roomFilter').addEventListener('change', function() {
                displayStates(entities);
            });
        }
        if (document.getElementById('materialFilter')) {
            document.getElementById('materialFilter').addEventListener('change', function() {
                displayStates(entities);
            });
        }
    </script>
</body>
</html>