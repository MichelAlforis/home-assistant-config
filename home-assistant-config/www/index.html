<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>üè† Home Assistant Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- CSS modulaire - Ordre d'importation important -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/colors.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/enhancements.css">
    <link rel="stylesheet" href="css/advanced-controls.css">
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4a90e2">
    <meta name="apple-mobile-web-app-title" content="HA Dashboard">
    
    <!-- Favicons et ic√¥nes personnalis√©s -->
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
    <link rel="icon" type="image/png" href="/icons/icon.png">
</head>
<body>
    <!-- Panel de debug -->
    <div class="debug-panel" id="debugPanel">
        <strong>DEBUG:</strong> <span id="debugText">Initialisation...</span>
    </div>

    <!-- En-t√™te -->
    <div class="header">
        <h1>üè† Home Assistant</h1>
        <div class="header-info">Tableau de bord connect√©</div>
        
        <!-- Indicateur de connexion -->
        <div class="connection-status" id="connectionStatus">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Non connect√©</span>
        </div>
        
        <!-- Filtres de navigation -->
        <div class="filter-tabs" id="filterTabs">
            <button class="filter-tab active" onclick="switchToFilter('all', this)">Tout</button>
            <button class="filter-tab" onclick="switchToFilter('pieces', this)">Pi√®ces</button>
            <button class="filter-tab" onclick="switchToFilter('materiel', this)">Mat√©riel</button>
            <button class="filter-tab" onclick="switchToFilter('scenarios', this)">Sc√©narios</button>
        </div>
    </div>

    <!-- Panel de configuration -->
    <div class="config-panel" id="configPanel">
        <h3>‚öôÔ∏è Configuration de connexion</h3>
        <div class="config-form">
            <input type="text" 
                   id="haUrl" 
                   name="url" 
                   placeholder="URL Home Assistant (ex: http://192.168.1.100:8123)" 
                   autocomplete="url" />
            <input type="password" 
                   id="haToken" 
                   name="token" 
                   placeholder="Token d'acc√®s long terme" 
                   autocomplete="off" />
            <div class="config-buttons">
                <button class="btn-primary" onclick="saveConfig()">Se connecter</button>
                <button class="btn-secondary" onclick="testConnection()">üîß Test Connexion</button>
            </div>
        </div>
        <div class="config-help">
            üí° Pour cr√©er un token : Profil ‚Üí Tokens d'acc√®s long terme
        </div>
        <div class="config-quick-setup" id="configQuickSetup" style="display: none;">
            <h4>‚ö° Configuration rapide</h4>
            <button onclick="loadDemoConfig()">Mode D√©mo</button>
            <button onclick="loadLocalConfig()">Configuration Locale</button>
        </div>
    </div>

    <!-- Indicateur de chargement -->
    <div class="loading" id="loading" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">üîÑ Connexion en cours...</div>
        <div class="loading-details" id="loadingDetails">Initialisation des modules...</div>
    </div>
    
    <!-- Contenu principal -->
    <div class="page-content" id="dashboardPage">
        <div class="dashboard-container">
            <!-- Vue principale - Toutes les entit√©s -->
            <div class="dashboard-grid" id="allContent">
                <div class="welcome-card" id="welcomeCard">
                    <h2>üè† Bienvenue sur votre Dashboard</h2>
                    <p>Configurez votre connexion Home Assistant pour commencer.</p>
                </div>
            </div>
            
            <!-- Vue Pi√®ces -->
            <div class="rooms-grid" id="piecesContent" style="display: none;"></div>
            <div id="pieceDetails" style="display: none;">
                <div class="back-nav">
                    <button class="back-btn" onclick="showPiecesList()">‚Üê Retour aux pi√®ces</button>
                    <h2 id="pieceDetailsTitle">D√©tails de la pi√®ce</h2>
                </div>
                <div class="dashboard-container">
                    <div class="dashboard-grid" id="pieceEntities"></div>
                </div>
            </div>
            
            <!-- Vue Mat√©riel -->
            <div class="material-grid" id="materielContent" style="display: none;"></div>
            <div id="materielDetails" style="display: none;">
                <div class="back-nav">
                    <button class="back-btn" onclick="showMaterielList()">‚Üê Retour au mat√©riel</button>
                    <h2 id="materielDetailsTitle">D√©tails du mat√©riel</h2>
                </div>
                <div class="dashboard-container">
                    <div class="dashboard-grid" id="materielEntities"></div>
                </div>
            </div>
            
            <!-- Vue Sc√©narios -->
            <div class="scenarios-grid" id="scenariosContent" style="display: none;">
                <div class="scenarios-placeholder">
                    <h3>üé¨ Sc√©narios</h3>
                    <p>Les sc√©narios Home Assistant appara√Ætront ici une fois connect√©.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Barre de statut -->
    <div class="status-bar" id="statusBar">
        <span class="status-update">üîÑ Derni√®re mise √† jour : --:--:--</span>
        <span class="status-entities" id="statusEntities">Entit√©s : 0</span>
        <span class="status-version">v2.0</span>
    </div>

    <!-- Container pour les messages (g√©r√© par le module messages.js) -->
    <div id="ha-messages-container"></div>

    <!-- Scripts modulaires - ORDRE CRITIQUE -->
    <!-- 1. Configuration et utilitaires de base -->
    <script src="js/core/config.js"></script>
    <script src="js/core/utils.js"></script>
    
    <!-- 2. Services -->
    <script src="js/services/ha-service.js"></script>
    
    <!-- 3. Interface utilisateur -->
    <script src="js/ui/messages.js"></script>
    
    <!-- 4. Modules fonctionnels -->
    <script src="js/modules/climate-control.js"></script>
    <script src="js/modules/cover-control.js"></script>
    
    <!-- 5. Orchestrateur principal -->
    <script src="js/dashboard.js"></script>
    
    <!-- 6. Compatibilit√© avec l'ancien syst√®me (optionnel) -->
    <script>
        // Adapter l'ancien syst√®me avec la nouvelle architecture
        var legacyAdapter = {
            // Fonctions de compatibilit√© avec votre ancien code
            switchToFilter: function(filterType, buttonElement) {
                // Logique de filtrage adapt√©e
                var allTabs = document.querySelectorAll('.filter-tab');
                for (var i = 0; i < allTabs.length; i++) {
                    allTabs[i].classList.remove('active');
                }
                buttonElement.classList.add('active');
                
                // Masquer tous les contenus
                var contents = ['allContent', 'piecesContent', 'materielContent', 'scenariosContent'];
                for (var j = 0; j < contents.length; j++) {
                    var element = document.getElementById(contents[j]);
                    if (element) {
                        element.style.display = 'none';
                    }
                }
                
                // Afficher le contenu s√©lectionn√©
                var targetContent = {
                    'all': 'allContent',
                    'pieces': 'piecesContent',
                    'materiel': 'materielContent',
                    'scenarios': 'scenariosContent'
                };
                
                var target = document.getElementById(targetContent[filterType]);
                if (target) {
                    target.style.display = 'block';
                }
                
                HAUtils.debugLog('Switched to filter: ' + filterType);
            },
            
            saveConfig: function() {
                var url = document.getElementById('haUrl').value;
                var token = document.getElementById('haToken').value;
                
                if (!url || !token) {
                    if (window.HAMessages) {
                        HAMessages.showError('‚ö†Ô∏è URL et Token requis');
                    } else {
                        alert('URL et Token requis');
                    }
                    return;
                }
                
                // Sauvegarder dans localStorage
                if (HAUtils && HAUtils.hasLocalStorage()) {
                    try {
                        localStorage.setItem('ha-url', url);
                        localStorage.setItem('ha-token', token);
                    } catch (e) {
                        HAUtils.debugLog('Erreur sauvegarde config: ' + e.message);
                    }
                }
                
                // Configurer le service
                if (window.HAService) {
                    HAService.configure(url, token);
                    
                    // Tester la connexion
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('configPanel').style.display = 'none';
                    
                    HAService.checkConnection(function(success) {
                        document.getElementById('loading').style.display = 'none';
                        
                        if (success) {
                            if (window.HAMessages) {
                                HAMessages.showSuccess('‚úÖ Connexion √©tablie !');
                            }
                            legacyAdapter.updateConnectionStatus(true);
                            legacyAdapter.loadInitialData();
                        } else {
                            if (window.HAMessages) {
                                HAMessages.showError('‚ùå Erreur de connexion');
                            }
                            document.getElementById('configPanel').style.display = 'block';
                        }
                    });
                }
            },
            
            testConnection: function() {
                var url = document.getElementById('haUrl').value;
                var token = document.getElementById('haToken').value;
                
                if (!url) {
                    if (window.HAMessages) {
                        HAMessages.showWarning('‚ö†Ô∏è URL requise pour le test');
                    }
                    return;
                }
                
                // Test simple de l'URL
                if (window.HAService) {
                    HAService.configure(url, token);
                    HAService.checkConnection(function(success) {
                        if (success) {
                            if (window.HAMessages) {
                                HAMessages.showSuccess('‚úÖ Connexion OK !');
                            }
                        } else {
                            if (window.HAMessages) {
                                HAMessages.showError('‚ùå Connexion √©chou√©e');
                            }
                        }
                    });
                }
            },
            
            loadDemoConfig: function() {
                document.getElementById('haUrl').value = 'http://demo.home-assistant.io:8123';
                document.getElementById('haToken').value = 'demo-token-for-testing';
                if (window.HAMessages) {
                    HAMessages.showInfo('üé≠ Configuration de d√©mo charg√©e');
                }
            },
            
            loadLocalConfig: function() {
                document.getElementById('haUrl').value = 'http://192.168.1.100:8123';
                if (window.HAMessages) {
                    HAMessages.showInfo('üè† Configuration locale sugg√©r√©e');
                }
                document.getElementById('haToken').focus();
            },
            
            updateConnectionStatus: function(connected) {
                var statusDot = document.getElementById('statusDot');
                var statusText = document.getElementById('statusText');
                
                if (statusDot && statusText) {
                    if (connected) {
                        statusDot.className = 'status-dot connected';
                        statusText.textContent = 'Connect√©';
                    } else {
                        statusDot.className = 'status-dot disconnected';
                        statusText.textContent = 'D√©connect√©';
                    }
                }
            },
            
            loadInitialData: function() {
                if (window.Dashboard && Dashboard.state) {
                    // Masquer la carte de bienvenue
                    var welcomeCard = document.getElementById('welcomeCard');
                    if (welcomeCard) {
                        welcomeCard.style.display = 'none';
                    }
                    
                    // Charger les donn√©es via le Dashboard
                    Dashboard._loadEntities();
                }
            },
            
            showPiecesList: function() {
                document.getElementById('pieceDetails').style.display = 'none';
                document.getElementById('piecesContent').style.display = 'block';
            },
            
            showMaterielList: function() {
                document.getElementById('materielDetails').style.display = 'none';
                document.getElementById('materielContent').style.display = 'block';
            }
        };
        
        // Exposer les fonctions globalement pour la compatibilit√©
        window.switchToFilter = legacyAdapter.switchToFilter;
        window.saveConfig = legacyAdapter.saveConfig;
        window.testConnection = legacyAdapter.testConnection;
        window.loadDemoConfig = legacyAdapter.loadDemoConfig;
        window.loadLocalConfig = legacyAdapter.loadLocalConfig;
        window.showPiecesList = legacyAdapter.showPiecesList;
        window.showMaterielList = legacyAdapter.showMaterielList;
    </script>
    
    <!-- Initialisation -->
    <script>
        // Variables globales pour la compatibilit√©
        window.appInitialized = false;
        
        // Fonction d'initialisation principale
        function initApp() {
            if (window.appInitialized) return;
            
            HAUtils.debugLog('=== INITIALISATION DASHBOARD ===');
            
            // V√©rifier la compatibilit√©
            if (!HAUtils.isIOSCompatible()) {
                alert('Cette version d\'iOS pourrait ne pas √™tre enti√®rement support√©e.');
            }
            
            // Charger la configuration sauvegard√©e
            loadSavedConfig();
            
            // Afficher les boutons de configuration rapide sur iPad
            if (HAUtils.getDeviceType() === 'tablet') {
                var quickSetup = document.getElementById('configQuickSetup');
                if (quickSetup) {
                    quickSetup.style.display = 'block';
                }
            }
            
            // Initialiser le debug
            updateDebugText('Dashboard initialis√©');
            
            // Marquer comme initialis√©
            window.appInitialized = true;
            
            HAUtils.debugLog('=== INITIALISATION TERMIN√âE ===');
        }
        
        function loadSavedConfig() {
            if (HAUtils.hasLocalStorage()) {
                try {
                    var savedUrl = localStorage.getItem('ha-url');
                    var savedToken = localStorage.getItem('ha-token');
                    
                    if (savedUrl && savedToken) {
                        document.getElementById('haUrl').value = savedUrl;
                        document.getElementById('haToken').value = savedToken;
                        
                        // Auto-connexion
                        setTimeout(function() {
                            legacyAdapter.saveConfig();
                        }, 1000);
                        
                        HAUtils.debugLog('Configuration charg√©e depuis localStorage');
                    } else {
                        // Afficher le panel de configuration si pas de config
                        document.getElementById('configPanel').style.display = 'block';
                    }
                } catch (e) {
                    HAUtils.debugLog('Erreur chargement config: ' + e.message);
                    document.getElementById('configPanel').style.display = 'block';
                }
            } else {
                document.getElementById('configPanel').style.display = 'block';
            }
        }
        
        function updateDebugText(text) {
            var debugElement = document.getElementById('debugText');
            if (debugElement) {
                debugElement.textContent = text + ' - ' + new Date().toLocaleTimeString();
            }
        }
        
        // Service Worker pour PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        HAUtils.debugLog('Service Worker enregistr√©: ' + registration.scope);
                    })
                    .catch(function(error) {
                        HAUtils.debugLog('Erreur Service Worker: ' + error);
                    });
            });
        }
        
        // D√©marrage de l'application
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            // Document d√©j√† charg√©
            setTimeout(initApp, 100);
        }
        
        // Gestion des erreurs globales
        window.addEventListener('error', function(e) {
            updateDebugText('Erreur: ' + e.message);
            if (window.HAMessages) {
                HAMessages.showError('Erreur: ' + e.message);
            }
        });
        
        // Mise √† jour p√©riodique du statut
        setInterval(function() {
            if (window.Dashboard && Dashboard.state && Dashboard.state.lastUpdateTime) {
                var lastUpdate = new Date(Dashboard.state.lastUpdateTime);
                var statusBar = document.getElementById('statusBar');
                if (statusBar) {
                    var timeStr = lastUpdate.toLocaleTimeString();
                    var entitiesCount = Object.keys(Dashboard.state.entities || {}).length;
                    
                    statusBar.innerHTML = 
                        '<span class="status-update">üîÑ Derni√®re MAJ : ' + timeStr + '</span>' +
                        '<span class="status-entities">Entit√©s : ' + entitiesCount + '</span>' +
                        '<span class="status-version">v2.0</span>';
                }
            }
        }, 5000);
    </script>
</body>
</html>